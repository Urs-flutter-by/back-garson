# Сводка рефакторинга (Часть 13): Отладка и исправление ошибок

### Цель
Устранить серию критических ошибок (`401 Unauthorized` и `500 Internal Server Error`), возникавших при взаимодействии фронтенда с новыми эндпоинтами, и добиться стабильной работы системы.

### Что сделано

1.  **Исправлена архитектура Middleware:**
    - Убрана глобальная аутентификация из `routes/_middleware.dart`, которая ошибочно блокировала публичные эндпоинты.
    - Добавлены локальные `middleware` в папки `routes/app/` и `routes/users/` для защиты только тех эндпоинтов, которые требуют авторизации.

2.  **Исправлена логика гостевой сессии и WebSocket:**
    - Эндпоинт `GET /web/status/{tableId}` теперь корректно возвращает `token` и `restaurantId` без предварительной авторизации.
    - `authenticationMiddleware` доработан для поддержки гостевых токенов, передаваемых через query-параметр `?token=...`, что решило проблему с подключением к WebSocket из веб-приложения.
    - Исправлена ошибка в `routes/updates.dart`, которая принудительно закрывала WebSocket-соединение для гостевых пользователей.

3.  **Устранены ошибки несоответствия типов данных:**
    - Проведен рефакторинг доменной модели `OrderItem`, чтобы `dishId` имел тип `int` в соответствии со схемой БД.
    - Исправлены многочисленные ошибки в SQL-запросах и логике парсинга (`routes/web/order/items.dart`, `order_repository_impl.dart`), связанные с неверной обработкой типов `UUID`, `int` и `String` для `order_id` и `dish_id`.
    - Исправлена ошибка в синтаксисе SQL-запроса (замена `@param` на `$1`).

4.  **Улучшена обработка ошибок:**
    - В ключевой эндпоинт `POST /web/order/items` добавлено логирование в `catch` блок для быстрой диагностики падений сервера.

### Результат
Все известные на данный момент ошибки устранены. Бэкенд корректно обрабатывает оба сценария аутентификации (для сотрудников и гостей), а также запросы на создание позиций заказа. Система стабилизирована и готова к дальнейшему тестированию и разработке.
