# Руководство по интеграции фронтенда

Этот документ описывает, как фронтенд-приложениям (Flutter для персонала, веб для клиентов) взаимодействовать с обновленным бэкендом.

## 1. Обзор ключевых изменений

1.  **Система ролей (RBAC):** Бэкенд теперь различает пользователей по ролям (`ADMIN_RESTAURANT`, `WAITER`, `CHEF`, `CUSTOMER`).
2.  **Аутентификация через JWT:** Вход в систему для сотрудников и гостевые сессии для клиентов теперь работают через JWT-токены.
3.  **Real-time обновления через WebSockets:** Появилась система мгновенных уведомлений.

---

## 2. Аутентификация клиента (Гостевой доступ)

Этот механизм предназначен для веб-приложения, которое клиент открывает, отсканировав QR-код.

**Эндпоинт:** `GET /web/status/{tableId}`

**Запрос:**
Никакого тела запроса не требуется. Клиент просто переходит по URL, который был зашит в QR-коде. `tableId` передается как часть URL.

**Ответ (Success Response):**
Бэкенд проверяет, существует ли столик, и в случае успеха возвращает **гостевой JWT-токен**.
```json
{
  "token": "ey... (длинная строка гостевого токена)"
}
```
Внутри этого токена зашита информация о столике, ресторане и роль `CUSTOMER`.

### Как использовать гостевой токен:

1.  **Сохранение:** Сразу после получения токена, веб-приложение должно сохранить его (например, в `sessionStorage` браузера).
2.  **Использование:** Этот токен должен использоваться для всех последующих действий клиента: для получения меню, создания заказа и для подключения к WebSocket для отслеживания статуса своего заказа.

---

## 3. Аутентификация сотрудников (для мобильного приложения персонала)

Процесс входа в систему для официантов, поваров и администраторов.

**Эндпоинт:** `POST /app/auth/login`

**Запрос (Request Body):**
Отправьте JSON с логином, паролем и ID ресторана.
```json
{
  "login": "waiter_login",
  "password": "some_password",
  "restaurantId": "...-uuid-..."
}
```

**Ответ (Success Response):**
Бэкенд возвращает JWT-токен сотрудника.
```json
{
  "token": "ey... (длинная строка токена сотрудника)"
}
```

### Как использовать токен сотрудника:

1.  **Сохранение:** Приложение должно надежно сохранить полученный `token` (например, в `FlutterSecureStorage`).
2.  **Использование:** Токен используется для всех защищенных HTTP-запросов и для установки WebSocket-соединения, как описано ниже.

---

## 4. Real-time Уведомления через WebSockets

Для получения мгновенных обновлений приложение (и клиента, и сотрудника) должно установить постоянное WebSocket-соединение.

**Эндпоинт:** `ws://<your_domain>/updates` (или `wss://` для защищенного соединения)

### Как подключиться:

Используйте пакет `web_socket_channel`. При подключении **обязательно** передайте соответствующий JWT-токен (гостевой или сотрудника) в заголовках.

```dart
import 'package:web_socket_channel/web_socket_channel.dart';

// Получаем токен из хранилища
final token = await storage.read(key: 'jwt_token');

// Устанавливаем соединение
final channel = WebSocketChannel.connect(
  Uri.parse('ws://<your_domain>/updates'),
  headers: {
    'Authorization': 'Bearer $token',
  },
);

// Начинаем слушать входящие сообщения
channel.stream.listen((message) {
  print('Получено новое сообщение от сервера: $message');
  // Здесь будет ваша логика обработки сообщения
});
```

### Формат сообщений от сервера

Сервер будет присылать сообщения в формате JSON со стандартизированной структурой:

```json
{
  "event": "<название_события>",
  "data": { ... }
}
```

**Пример сообщения об изменении статуса заказа:**

```json
{
  "event": "order_status_changed",
  "data": {
    "orderId": "12345",
    "newStatus": "PREPARING"
  }
}
```

**Логика фронтенда:**
Ваше приложение должно парсить входящую строку `message` в JSON, смотреть на значение поля `event` и, в зависимости от него, выполнять нужные действия (например, найти в списке заказов заказ с `orderId` и обновить его статус на `PREPARING`).

---

## 5. Обработка кодов ошибок

При взаимодействии с бэкендом фронтенд должен быть готов обрабатывать следующие HTTP статусы ошибок:

- **`401 Unauthorized`**: Возвращается, если:
  - Токен не предоставлен.
  - Токен невалидный (неверная подпись).
  - Срок действия токена истек.
  - **Действие фронтенда:** Разлогинить пользователя / перенаправить на экран входа.

- **`402 Payment Required`**: Возвращается, если подписка аккаунта неактивна.
  - **Действие фронтенда:** Показать пользователю сообщение о том, что подписка неактивна и функционал ограничен. Разлогинить.

- **`403 Forbidden`**: Возвращается, если:
  - У роли пользователя недостаточно прав для выполнения действия (например, официант пытается удалить ресторан).
  - Превышен лимит по тарифу (например, попытка добавить 6-го официанта при лимите в 5).
  - **Действие фронтенда:** Показать пользователю сообщение "Доступ запрещен" или "Недостаточно прав".

- **`404 Not Found`**: Ресурс не найден (например, запрос данных по несуществующему ID столика или заказа).
  - **Действие фронтенда:** Показать страницу "Не найдено" или соответствующее сообщение.
