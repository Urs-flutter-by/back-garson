# Руководство по интеграции фронтенда

Этот документ описывает, как фронтенд-приложениям (Flutter для персонала, веб для клиентов) взаимодействовать с обновленным бэкендом.

## 1. Обзор ключевых изменений

1.  **Система ролей (RBAC):** Бэкенд теперь различает пользователей по ролям (`ADMIN_RESTAURANT`, `WAITER`, `CHEF`, `CUSTOMER`).
2.  **Аутентификация через JWT:** Вход в систему для сотрудников теперь работает через JWT-токены.
3.  **Real-time обновления через WebSockets:** Появилась система мгновенных уведомлений.

---

## 2. Аутентификация сотрудников (для мобильного приложения персонала)

Процесс входа в систему был полностью изменен.

**Эндпоинт:** `POST /app/auth/login`

**Запрос (Request Body):**
Отправьте JSON с логином, паролем и ID ресторана.
```json
{
  "login": "waiter_login",
  "password": "some_password",
  "restaurantId": "...-uuid-..."
}
```

**Ответ (Success Response):**
Вместо полной модели пользователя, бэкенд теперь возвращает только JWT-токен.
```json
{
  "token": "ey... (длинная строка токена)"
}
```

### Как использовать токен:

1.  **Сохранение:** После успешного входа фронтенд-приложение должно надежно сохранить полученный `token` (например, в `FlutterSecureStorage`).

2.  **Использование в HTTP-запросах:** При **каждом** последующем запросе к защищенным эндпоинтам бэкенда, вы **обязаны** добавлять заголовок `Authorization`.

    ```dart
    // Пример HTTP-запроса с токеном
    final token = await secureStorage.read(key: 'jwt_token');
    final response = await http.get(
      Uri.parse('https://your_domain/api/some_resource'),
      headers: {
        'Authorization': 'Bearer $token',
      },
    );
    ```

3.  **Использование в WebSocket:** Этот же токен используется для аутентификации при установке WebSocket-соединения (см. следующий раздел).

---

## 3. Real-time Уведомления через WebSockets

Для получения мгновенных обновлений (например, о статусе заказа) приложение должно установить постоянное WebSocket-соединение.

**Эндпоинт:** `ws://<your_domain>/updates` (или `wss://` для защищенного соединения)

### Как подключиться:

Используйте пакет `web_socket_channel` в вашем Flutter-приложении. При подключении **обязательно** передайте JWT-токен в заголовках.

```dart
import 'package:web_socket_channel/web_socket_channel.dart';

// Получаем токен из хранилища
final token = await secureStorage.read(key: 'jwt_token');

// Устанавливаем соединение
final channel = WebSocketChannel.connect(
  Uri.parse('ws://<your_domain>/updates'),
  headers: {
    'Authorization': 'Bearer $token',
  },
);

// Начинаем слушать входящие сообщения
channel.stream.listen((message) {
  print('Получено новое сообщение от сервера: $message');
  // Здесь будет ваша логика обработки сообщения
});
```

### Формат сообщений от сервера

Сервер будет присылать сообщения в формате JSON со стандартизированной структурой:

```json
{
  "event": "<название_события>",
  "data": { ... }
}
```

**Пример сообщения об изменении статуса заказа:**

```json
{
  "event": "order_status_changed",
  "data": {
    "orderId": "12345",
    "newStatus": "PREPARING"
  }
}
```

**Логика фронтенда:**
Ваше приложение должно парсить входящую строку `message` в JSON, смотреть на значение поля `event` и, в зависимости от него, выполнять нужные действия (например, найти в списке заказов заказ с `orderId` и обновить его статус на `PREPARING`).
